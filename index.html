<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Gerador</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,700&display=swap');

*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}

:root{
  --blue:#1a56e8;--blue-d:#1240c0;--blue-l:#e8effe;
  --green:#22c55e;--red:#ef4444;--orange:#f59e0b;
  --gray:#6b7280;--bg:#f0f2f7;--white:#ffffff;
  --text:#111827;--text2:#6b7280;--radius:16px;
  --shadow:0 2px 14px rgba(0,0,0,0.08);
}

html,body{font-family:'DM Sans',sans-serif;background:#c7cfe0;display:flex;justify-content:center;align-items:center;min-height:100vh;}

.phone{width:100%;max-width:430px;height:100dvh;max-height:932px;background:var(--bg);position:relative;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 0 80px rgba(0,0,0,0.35);}

/* PAGES */
.page{display:none;flex-direction:column;height:100%;overflow:hidden;}
.page.active{display:flex;}
.scroll-area{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding-bottom:84px;}
.scroll-area::-webkit-scrollbar{display:none;}

/* ===== HOME ===== */
.home-header{background:linear-gradient(145deg,#1a56e8 0%,#1240c0 100%);padding:20px 20px 48px;flex-shrink:0;}
.home-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;}
.user-info{display:flex;align-items:center;gap:12px;}
.avatar{width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,#0d0d0d,#2a2a2a);display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:800;color:#f59e0b;font-style:italic;border:2px solid rgba(255,255,255,0.2);}
.user-name{color:#fff;font-size:17px;font-weight:700;line-height:1.2;}
.user-plan{color:rgba(255,255,255,0.65);font-size:12px;margin-top:2px;}
.header-icons{display:flex;gap:14px;}
.header-icons button{background:rgba(255,255,255,0.15);border:none;cursor:pointer;width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;transition:background 0.15s;}
.header-icons button:active{background:rgba(255,255,255,0.25);}

/* LIMIT BAR */
.limit-bar-wrap{background:rgba(255,255,255,0.1);border-radius:12px;padding:10px 14px;margin-bottom:14px;}
.limit-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
.limit-label{color:rgba(255,255,255,0.8);font-size:11px;font-weight:600;letter-spacing:0.05em;text-transform:uppercase;}
.limit-count{color:#fff;font-size:13px;font-weight:700;}
.limit-bar-bg{background:rgba(255,255,255,0.2);border-radius:99px;height:5px;overflow:hidden;}
.limit-bar-fill{height:100%;background:linear-gradient(90deg,#4ade80,#22c55e);border-radius:99px;transition:width 0.5s ease;}

.stats-cards{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.stat-card{background:rgba(255,255,255,0.13);border-radius:14px;padding:14px;color:#fff;cursor:pointer;transition:transform 0.15s;border:1px solid rgba(255,255,255,0.1);}
.stat-card:active{transform:scale(0.97);}
.stat-label{font-size:11px;opacity:0.75;display:flex;align-items:center;gap:5px;margin-bottom:5px;text-transform:uppercase;letter-spacing:0.04em;font-weight:600;}
.stat-num{font-size:30px;font-weight:800;}
.stat-footer{display:flex;align-items:center;justify-content:space-between;margin-top:8px;}
.stat-sub{font-size:11px;opacity:0.75;}
.stat-sub-val{font-size:13px;font-weight:700;color:#fff;}
.stat-sub-val.danger{color:#fca5a5;}
.go-btn{width:28px;height:28px;border-radius:50%;background:var(--green);display:flex;align-items:center;justify-content:center;flex-shrink:0;}

.home-body{background:var(--bg);border-radius:24px 24px 0 0;margin-top:-20px;flex:1;overflow-y:auto;padding:22px 14px 0;}
.home-body::-webkit-scrollbar{display:none;}

.quick-actions{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:22px;}
.qa-btn{display:flex;flex-direction:column;align-items:center;gap:7px;cursor:pointer;}
.qa-icon{width:62px;height:62px;border-radius:16px;background:var(--white);display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow);transition:transform 0.15s;}
.qa-btn:active .qa-icon{transform:scale(0.9);}
.qa-label{font-size:11px;color:var(--text);font-weight:600;text-align:center;line-height:1.3;}

.section-title{font-size:14px;font-weight:700;color:var(--text);margin-bottom:10px;}
.chart-card{background:var(--white);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);margin-bottom:16px;}
.chart-legend{display:flex;align-items:center;gap:8px;margin-bottom:14px;}
.chart-dot{width:10px;height:10px;border-radius:50%;background:var(--blue);}
.chart-legend-label{font-size:13px;font-weight:600;color:var(--text);}
canvas{width:100%!important;display:block;}

/* ===== PAGE HEADER ===== */
.page-header{background:var(--white);padding:14px 16px;display:flex;align-items:center;gap:10px;flex-shrink:0;border-bottom:1px solid #f0f2f7;box-shadow:0 2px 8px rgba(0,0,0,0.04);}
.page-header-icon{font-size:20px;}
.page-header-title{font-size:17px;font-weight:700;color:var(--text);flex:1;}
.page-header-actions{display:flex;align-items:center;gap:10px;}
.ph-btn{background:none;border:none;cursor:pointer;padding:5px;display:flex;border-radius:8px;transition:background 0.1s;}
.ph-btn:active{background:var(--bg);}

.search-bar{padding:10px 14px;background:var(--white);border-bottom:1px solid #f0f2f7;flex-shrink:0;}
.search-input{width:100%;padding:9px 14px;border:1.5px solid #e5e7eb;border-radius:10px;font-size:14px;font-family:inherit;outline:none;background:var(--bg);transition:border-color 0.2s;}
.search-input:focus{border-color:var(--blue);}

/* ===== LIST ITEMS ===== */
.list-container{padding:4px 0;}
.list-item{background:var(--white);border-bottom:1px solid #f3f4f6;padding:14px 14px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:background 0.1s;}
.list-item:first-child{border-top:1px solid #f3f4f6;}
.list-item:active{background:#f9fafb;}
.list-item.selected{background:#eff6ff;}

.item-check{width:22px;height:22px;border-radius:50%;border:2px solid #c7d2fe;flex-shrink:0;transition:all 0.15s;display:flex;align-items:center;justify-content:center;}
.item-check.checked{background:var(--blue);border-color:var(--blue);}
.item-check.checked::after{content:'';width:6px;height:6px;border-radius:50%;background:#fff;}

.item-body{flex:1;min-width:0;}
.item-key{font-size:13.5px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.item-key.red-key{color:var(--red);}
.item-meta{font-size:12px;color:var(--gray);margin-top:2px;}
.item-meta.online{color:var(--green);font-weight:600;}
.item-meta.offline{color:var(--red);font-weight:500;}

.badge{padding:3px 11px;border-radius:20px;font-size:11px;font-weight:700;flex-shrink:0;letter-spacing:0.02em;}
.badge.active{background:#dcfce7;color:#15803d;}
.badge.pending{background:#fef3c7;color:#92400e;}
.badge.expired{background:#fee2e2;color:#991b1b;}
.badge.used{background:#e0f2fe;color:#075985;}

/* COPY BTN */
.copy-btn{background:var(--blue-l);border:none;cursor:pointer;width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:background 0.15s;}
.copy-btn:active{background:#c7d2fe;}

/* ===== PACKAGES ===== */
.pkg-item{background:var(--white);border-bottom:1px solid #f3f4f6;padding:14px 16px;display:flex;align-items:center;gap:12px;}
.pkg-icon{width:38px;height:38px;border-radius:12px;background:var(--blue-l);display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.pkg-body{flex:1;}
.pkg-name{font-size:14px;font-weight:700;color:var(--text);}
.pkg-url{font-size:11px;color:var(--gray);margin-top:3px;word-break:break-all;}
.pkg-sent{font-size:11px;color:var(--blue);font-weight:600;margin-top:2px;}

.toggle{width:50px;height:30px;border-radius:20px;background:var(--blue);position:relative;cursor:pointer;flex-shrink:0;transition:background 0.2s;}
.toggle.off{background:#d1d5db;}
.toggle-knob{width:26px;height:26px;border-radius:50%;background:#fff;position:absolute;top:2px;left:22px;box-shadow:0 1px 4px rgba(0,0,0,0.2);transition:left 0.2s;}
.toggle.off .toggle-knob{left:2px;}

.pkg-actions{display:flex;gap:8px;padding:10px 14px;background:var(--bg);}
.pkg-action-btn{flex:1;padding:10px;border:1.5px solid #e5e7eb;border-radius:10px;background:var(--white);font-size:13px;font-weight:600;font-family:inherit;cursor:pointer;color:var(--text);transition:all 0.15s;}
.pkg-action-btn.primary{background:var(--blue);color:#fff;border-color:var(--blue);}
.pkg-action-btn:active{transform:scale(0.97);}

/* ===== PROFILE ===== */
.profile-header{background:linear-gradient(145deg,#1a56e8,#1240c0);padding:36px 20px 28px;text-align:center;flex-shrink:0;}
.profile-avatar{width:76px;height:76px;border-radius:50%;background:linear-gradient(135deg,#0d0d0d,#2a2a2a);display:flex;align-items:center;justify-content:center;font-size:34px;font-weight:800;color:#f59e0b;font-style:italic;margin:0 auto 12px;border:3px solid rgba(255,255,255,0.2);}
.profile-name{color:#fff;font-size:19px;font-weight:700;}
.profile-plan{color:rgba(255,255,255,0.65);font-size:13px;margin-top:4px;}

.profile-body{flex:1;overflow-y:auto;padding:18px 14px 90px;}
.profile-body::-webkit-scrollbar{display:none;}

.stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:18px;}
.mini-stat{background:var(--white);border-radius:14px;padding:14px 10px;text-align:center;box-shadow:var(--shadow);}
.mini-stat-num{font-size:20px;font-weight:800;color:var(--blue);}
.mini-stat-label{font-size:10px;color:var(--gray);margin-top:3px;font-weight:600;text-transform:uppercase;letter-spacing:0.04em;}

.profile-section{margin-bottom:18px;}
.profile-section-title{font-size:11px;font-weight:700;color:var(--gray);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:8px;padding-left:4px;}
.profile-card{background:var(--white);border-radius:14px;overflow:hidden;box-shadow:var(--shadow);}
.profile-row{display:flex;align-items:center;justify-content:space-between;padding:13px 14px;border-bottom:1px solid #f3f4f6;cursor:pointer;transition:background 0.1s;}
.profile-row:last-child{border-bottom:none;}
.profile-row:active{background:var(--bg);}
.profile-row-left{display:flex;align-items:center;gap:11px;}
.pr-icon{width:32px;height:32px;border-radius:9px;background:var(--blue-l);display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.pr-label{font-size:14px;font-weight:500;color:var(--text);}
.pr-val{font-size:12px;color:var(--gray);}

/* ===== MODALS ===== */
.modal-overlay{position:absolute;inset:0;background:rgba(0,0,0,0.45);z-index:100;display:none;align-items:flex-end;}
.modal-overlay.open{display:flex;}
.modal{background:var(--white);border-radius:24px 24px 0 0;padding:20px 18px;width:100%;animation:slideUp 0.28s cubic-bezier(.32,.72,0,1);max-height:88%;overflow-y:auto;}
.modal::-webkit-scrollbar{display:none;}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}

.modal-handle{width:36px;height:4px;background:#e5e7eb;border-radius:99px;margin:0 auto 16px;}
.modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;}
.modal-title{font-size:17px;font-weight:700;color:var(--text);}
.modal-close-btn{background:var(--bg);border:none;cursor:pointer;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;}

/* FORM */
.form-group{margin-bottom:15px;}
.form-label{font-size:13px;font-weight:700;color:var(--text);margin-bottom:6px;display:block;}
.req{color:var(--red);}
.form-input,.form-select{width:100%;padding:11px 14px;border:1.5px solid #e5e7eb;border-radius:11px;font-size:15px;font-family:inherit;outline:none;background:var(--white);transition:border-color 0.2s;color:var(--text);}
.form-input:focus,.form-select:focus{border-color:var(--blue);}
.form-select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2'%3E%3Cpolyline points='6,9 12,15 18,9'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:36px;}
.form-hint{font-size:11px;color:var(--blue);margin-top:5px;font-weight:600;}
.form-hint.warn{color:var(--orange);}
.form-hint.err{color:var(--red);}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}

.preview-box{background:var(--bg);border-radius:11px;padding:12px 14px;font-size:12.5px;font-family:monospace;color:var(--text);word-break:break-all;border:1.5px dashed #c7d2fe;margin-bottom:15px;}
.preview-label{font-size:11px;font-weight:700;color:var(--gray);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:6px;}

.toggle-row{display:flex;align-items:center;justify-content:space-between;padding:13px 0;border-top:1px solid #f3f4f6;}
.toggle-row-txt .tl{font-size:14px;font-weight:600;color:var(--text);}
.toggle-row-txt .ts{font-size:11px;color:var(--gray);margin-top:2px;}

.create-btn{width:100%;padding:14px;background:linear-gradient(135deg,var(--blue),var(--blue-d));color:#fff;border:none;border-radius:13px;font-size:15px;font-weight:700;font-family:inherit;cursor:pointer;transition:all 0.2s;margin-top:14px;letter-spacing:0.02em;}
.create-btn:active{transform:scale(0.97);opacity:0.9;}
.create-btn:disabled{opacity:0.5;cursor:not-allowed;}

/* Package form modal */
.pkg-form-input{width:100%;padding:11px 14px;border:1.5px solid #e5e7eb;border-radius:11px;font-size:14px;font-family:inherit;outline:none;margin-bottom:10px;transition:border-color 0.2s;}
.pkg-form-input:focus{border-color:var(--blue);}

/* ===== BOTTOM NAV ===== */
.bottom-nav{position:absolute;bottom:0;left:0;right:0;height:72px;background:var(--white);border-top:1px solid #e9ecf3;display:grid;grid-template-columns:repeat(5,1fr);align-items:center;padding:0 4px;z-index:50;box-shadow:0 -4px 24px rgba(0,0,0,0.07);}
.nav-item{display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;padding:8px 4px;border-radius:12px;transition:all 0.15s;position:relative;}
.nav-label{font-size:10px;font-weight:600;color:var(--gray);transition:color 0.15s;letter-spacing:0.02em;}
.nav-item.active .nav-label{color:var(--blue);}
.nav-item svg{transition:all 0.15s;color:var(--gray);}
.nav-item.active svg{color:var(--blue);}
.nav-badge{position:absolute;top:4px;right:8px;background:var(--red);color:#fff;border-radius:99px;padding:1px 5px;font-size:9px;font-weight:700;}

/* ===== MISC ===== */
.loading{text-align:center;padding:48px 20px;color:var(--gray);}
.spinner{width:28px;height:28px;border:3px solid var(--blue-l);border-top-color:var(--blue);border-radius:50%;animation:spin 0.75s linear infinite;margin:0 auto 12px;}
@keyframes spin{to{transform:rotate(360deg)}}
.empty{text-align:center;padding:56px 20px;color:var(--gray);}
.empty-icon{font-size:44px;margin-bottom:12px;}
.empty-text{font-size:14px;font-weight:500;}
.toast{position:absolute;top:72px;left:50%;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 20px;border-radius:12px;font-size:13px;font-weight:600;z-index:300;white-space:nowrap;animation:toastAnim 3.2s ease forwards;pointer-events:none;box-shadow:0 4px 20px rgba(0,0,0,0.25);}
@keyframes toastAnim{0%{opacity:0;transform:translateX(-50%) translateY(-8px)}12%{opacity:1;transform:translateX(-50%) translateY(0)}80%{opacity:1}100%{opacity:0}}

/* Generated keys results */
.result-key-item{background:var(--bg);border-radius:10px;padding:10px 12px;margin-bottom:6px;display:flex;align-items:center;justify-content:space-between;gap:10px;}
.result-key-text{font-size:12px;font-family:monospace;color:var(--text);font-weight:600;flex:1;word-break:break-all;}
.result-copy-btn{background:var(--blue);border:none;cursor:pointer;width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}

/* Divider */
.divider{height:1px;background:#f0f2f7;margin:4px 0;}
.section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.section-btn{background:none;border:none;cursor:pointer;font-size:12px;font-weight:700;color:var(--blue);font-family:inherit;}

.limit-pill{background:var(--blue-l);border-radius:99px;padding:3px 10px;font-size:11px;font-weight:700;color:var(--blue);}

@media(max-width:430px){.phone{max-height:100dvh;border-radius:0;}html,body{background:var(--bg);}}
</style>
</head>
<body>
<div class="phone">

<!-- ========== HOME ========== -->
<div class="page active" id="page-home">
  <div class="home-header">
    <div class="home-top">
      <div class="user-info">
        <div class="avatar">G</div>
        <div>
          <div class="user-name">GHOST DASH</div>
          <div class="user-plan">âœ¦ Gold â€¢ Ativo</div>
        </div>
      </div>
      <div class="header-icons">
        <button onclick="refreshAll()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-4.95"/></svg>
        </button>
        <button onclick="openCreateModal()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        </button>
      </div>
    </div>

    <!-- LIMIT BAR -->
    <div class="limit-bar-wrap" style="margin-bottom:14px;">
      <div class="limit-row">
        <span class="limit-label">Keys Geradas</span>
        <span class="limit-count" id="limit-count-text">0 / 5.000</span>
      </div>
      <div class="limit-bar-bg"><div class="limit-bar-fill" id="limit-bar" style="width:0%"></div></div>
    </div>

    <div class="stats-cards">
      <div class="stat-card" onclick="navigate('keys')">
        <div class="stat-label">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6M15.5 7.5l3 3"/></svg>
          Keys
        </div>
        <div class="stat-num" id="stat-total">â€“</div>
        <div class="stat-footer">
          <div><div class="stat-sub">Pendentes</div><div class="stat-sub-val" id="stat-pending">â€“</div></div>
          <div class="go-btn"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg></div>
        </div>
      </div>
      <div class="stat-card" onclick="navigate('devices')">
        <div class="stat-label">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
          Devices
        </div>
        <div class="stat-num" id="stat-devices">â€“</div>
        <div class="stat-footer">
          <div><div class="stat-sub">Ativas</div><div class="stat-sub-val" id="stat-active">â€“</div></div>
          <div class="go-btn"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg></div>
        </div>
      </div>
    </div>
  </div>

  <div class="home-body">
    <div class="quick-actions">
      <div class="qa-btn" onclick="openCreateModal()">
        <div class="qa-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#1a56e8" stroke-width="2"><circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6M15.5 7.5l3 3"/></svg></div>
        <span class="qa-label">Criar Key</span>
      </div>
      <div class="qa-btn" onclick="navigate('packages')">
        <div class="qa-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#1a56e8" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg></div>
        <span class="qa-label">Packages</span>
      </div>
      <div class="qa-btn" onclick="copyAllPending()">
        <div class="qa-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#1a56e8" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></div>
        <span class="qa-label">Copiar All</span>
      </div>
      <div class="qa-btn" onclick="navigate('profile')">
        <div class="qa-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#1a56e8" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
        <span class="qa-label">Perfil</span>
      </div>
    </div>

    <div class="section-header">
      <span class="section-title">AtivaÃ§Ãµes Recentes</span>
    </div>
    <div class="chart-card">
      <div class="chart-legend">
        <div class="chart-dot"></div>
        <span class="chart-legend-label">Keys geradas por dia</span>
      </div>
      <canvas id="mainChart" height="170"></canvas>
    </div>

    <div class="section-header">
      <span class="section-title">Ãšltimas Keys</span>
      <button class="section-btn" onclick="navigate('keys')">Ver todas â†’</button>
    </div>
    <div id="home-keys-list" style="margin-bottom:20px;"></div>
  </div>
</div>

<!-- ========== KEYS ========== -->
<div class="page" id="page-keys">
  <div class="page-header">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#1a56e8" stroke-width="2"><circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6M15.5 7.5l3 3"/></svg>
    <span class="page-header-title">Keys <span class="limit-pill" id="keys-count-pill">0</span></span>
    <div class="page-header-actions">
      <button class="ph-btn" onclick="deleteSelected()" title="Deletar selecionadas">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
      </button>
      <button class="ph-btn" onclick="toggleSearch('keys')">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      </button>
      <button class="ph-btn" onclick="openCreateModal()">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#1a56e8" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      </button>
    </div>
  </div>
  <div class="search-bar" id="search-keys" style="display:none">
    <input class="search-input" placeholder="Buscar key..." oninput="filterKeys(this.value)"/>
  </div>
  <div class="scroll-area">
    <div id="keys-list"><div class="loading"><div class="spinner"></div>Carregando...</div></div>
  </div>
</div>

<!-- ========== DEVICES ========== -->
<div class="page" id="page-devices">
  <div class="page-header">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#1a56e8" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
    <span class="page-header-title">Devices</span>
    <div class="page-header-actions">
      <button class="ph-btn" onclick="toggleSearch('devices')">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      </button>
      <button class="ph-btn" onclick="refreshAll()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#1a56e8" stroke-width="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-4.95"/></svg>
      </button>
    </div>
  </div>
  <div class="search-bar" id="search-devices" style="display:none">
    <input class="search-input" placeholder="Buscar device ou key..." oninput="filterDevices(this.value)"/>
  </div>
  <div class="scroll-area">
    <div id="devices-list"><div class="loading"><div class="spinner"></div>Carregando...</div></div>
  </div>
</div>

<!-- ========== PACKAGES ========== -->
<div class="page" id="page-packages">
  <div class="page-header">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#1a56e8" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
    <span class="page-header-title">Packages</span>
    <div class="page-header-actions">
      <button class="ph-btn" onclick="openPkgModal()">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#1a56e8" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      </button>
    </div>
  </div>
  <div class="scroll-area">
    <div style="padding:12px 14px 0;">
      <div style="background:#eff6ff;border-radius:12px;padding:12px 14px;margin-bottom:12px;border:1.5px solid #bfdbfe;">
        <div style="font-size:12px;font-weight:700;color:#1e40af;margin-bottom:4px;">ðŸ“¦ O que sÃ£o Packages?</div>
        <div style="font-size:11px;color:#3b82f6;line-height:1.5;">Cada Package tem uma URL de API. Ao gerar keys, vocÃª escolhe um Package e as keys sÃ£o enviadas automaticamente para essa API.</div>
      </div>
    </div>
    <div id="packages-list"></div>
  </div>
</div>

<!-- ========== PROFILE ========== -->
<div class="page" id="page-profile">
  <div class="profile-header">
    <div class="profile-avatar">F</div>
    <div class="profile-name">FERRAO IOS</div>
    <div class="profile-plan">âœ¦ Plano Pro â€¢ Ativo</div>
  </div>
  <div class="profile-body">
    <div class="stats-row">
      <div class="mini-stat">
        <div class="mini-stat-num" id="prof-total">â€“</div>
        <div class="mini-stat-label">Total Keys</div>
      </div>
      <div class="mini-stat">
        <div class="mini-stat-num" id="prof-used">â€“</div>
        <div class="mini-stat-label">Ativas</div>
      </div>
      <div class="mini-stat">
        <div class="mini-stat-num" id="prof-pkgs">â€“</div>
        <div class="mini-stat-label">Packages</div>
      </div>
    </div>

    <div class="profile-section">
      <div class="profile-section-title">Conta</div>
      <div class="profile-card">
        <div class="profile-row">
          <div class="profile-row-left">
            <div class="pr-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#1a56e8" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
            <span class="pr-label">Username</span>
          </div>
          <span class="pr-val">ferrao_ios</span>
        </div>
        <div class="profile-row">
          <div class="profile-row-left">
            <div class="pr-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#1a56e8" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg></div>
            <span class="pr-label">Plano</span>
          </div>
          <span class="pr-val" style="color:#1a56e8;font-weight:700;">Pro</span>
        </div>
        <div class="profile-row">
          <div class="profile-row-left">
            <div class="pr-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#1a56e8" stroke-width="2"><circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6M15.5 7.5l3 3"/></svg></div>
            <span class="pr-label">Limite Keys</span>
          </div>
          <span class="pr-val" id="prof-limit">0 / 5.000</span>
        </div>
      </div>
    </div>

    <div class="profile-section">
      <div class="profile-section-title">API IntegraÃ§Ã£o</div>
      <div class="profile-card">
        <div class="profile-row" onclick="copyText('https://teste-api-mcok.vercel.app/keys')">
          <div class="profile-row-left">
            <div class="pr-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#1a56e8" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg></div>
            <span class="pr-label">API Base URL</span>
          </div>
          <span class="pr-val" style="font-size:10px;max-width:140px;text-align:right;word-break:break-all;">teste-api-mcok.vercel.app</span>
        </div>
        <div class="profile-row" onclick="refreshAll()">
          <div class="profile-row-left">
            <div class="pr-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#1a56e8" stroke-width="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-4.95"/></svg></div>
            <span class="pr-label">Atualizar dados</span>
          </div>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
        </div>
      </div>
    </div>

    <div class="profile-section">
      <div class="profile-section-title">IntegraÃ§Ã£o Externa</div>
      <div class="profile-card">
        <div class="profile-row" onclick="showIntegration()">
          <div class="profile-row-left">
            <div class="pr-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#1a56e8" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg></div>
            <span class="pr-label">CÃ³digo de IntegraÃ§Ã£o</span>
          </div>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
        </div>
        <div class="profile-row" onclick="resetAllKeys()">
          <div class="profile-row-left">
            <div class="pr-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg></div>
            <span class="pr-label" style="color:#ef4444;">Limpar todas as keys</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ========== MODAL: CREATE KEY ========== -->
<div class="modal-overlay" id="create-modal" onclick="closeOnBg(event,'create-modal')">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <span class="modal-title">ðŸ”‘ Criar Keys</span>
      <button class="modal-close-btn" onclick="closeModal('create-modal')">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#111" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>

    <div class="form-group">
      <label class="form-label">Quantidade <span class="req">*</span></label>
      <input class="form-input" type="number" id="key-qty" value="1" min="1" max="100" oninput="updatePreview()"/>
      <div class="form-hint" id="remaining-hint">DisponÃ­vel: calculando...</div>
    </div>

    <div class="form-group">
      <label class="form-label">DuraÃ§Ã£o <span class="req">*</span></label>
      <div class="form-row">
        <input class="form-input" type="number" id="key-duration" value="1" min="1" oninput="updatePreview()"/>
        <select class="form-select" id="key-type" onchange="updatePreview()">
          <option value="hour">Hour</option>
          <option value="day">Day</option>
          <option value="weekly" selected>Week</option>
          <option value="monthly">Month</option>
          <option value="lifetime">Lifetime</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">Package / Destino API <span class="req">*</span></label>
      <select class="form-select" id="key-package" onchange="updatePreview()">
        <option value="">â€” Selecionar package â€”</option>
      </select>
      <div class="form-hint" id="pkg-url-hint" style="margin-top:5px;word-break:break-all;"></div>
    </div>

    <div class="toggle-row">
      <div class="toggle-row-txt">
        <div class="tl">Auto clean key</div>
        <div class="ts">Remove keys nÃ£o usadas/expiradas</div>
      </div>
      <div class="toggle off" id="auto-clean-tog" onclick="this.classList.toggle('off')"><div class="toggle-knob"></div></div>
    </div>

    <div class="preview-label">Preview da key</div>
    <div class="preview-box" id="key-preview">FERRAO-weekly-xxxxxxxxxxxxxxxxxx</div>

    <div id="generated-results" style="display:none">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <span style="font-size:13px;font-weight:700;color:var(--text);">âœ… Keys Geradas</span>
        <button onclick="copyAllGenerated()" style="background:var(--blue);border:none;cursor:pointer;color:#fff;padding:5px 12px;border-radius:8px;font-size:11px;font-weight:700;font-family:inherit;">Copiar Todas</button>
      </div>
      <div id="generated-keys-list"></div>
    </div>

    <button class="create-btn" id="create-btn-main" onclick="createKeys()">
      âœ¦ Gerar Keys
    </button>
  </div>
</div>

<!-- ========== MODAL: ADD PACKAGE ========== -->
<div class="modal-overlay" id="pkg-modal" onclick="closeOnBg(event,'pkg-modal')">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <span class="modal-title">ðŸ“¦ Novo Package</span>
      <button class="modal-close-btn" onclick="closeModal('pkg-modal')">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#111" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="form-group">
      <label class="form-label">Nome do Package <span class="req">*</span></label>
      <input class="form-input" id="pkg-name" placeholder="Ex: api, loja1, scripts..." />
    </div>
    <div class="form-group">
      <label class="form-label">URL da API <span class="req">*</span></label>
      <input class="form-input" id="pkg-url" placeholder="https://sua-api.com/keys" type="url"/>
      <div class="form-hint">As keys serÃ£o enviadas via POST para essa URL</div>
    </div>
    <div class="form-group">
      <label class="form-label">DescriÃ§Ã£o (opcional)</label>
      <input class="form-input" id="pkg-desc" placeholder="Ex: API do sistema de scripts..."/>
    </div>
    <button class="create-btn" onclick="addPackage()">+ Adicionar Package</button>
  </div>
</div>

<!-- ========== MODAL: INTEGRATION ========== -->
<div class="modal-overlay" id="integration-modal" onclick="closeOnBg(event,'integration-modal')">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <span class="modal-title">ðŸ”Œ IntegraÃ§Ã£o</span>
      <button class="modal-close-btn" onclick="closeModal('integration-modal')">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#111" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div style="font-size:12px;font-weight:700;color:var(--gray);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:8px;">Verificar key (JavaScript/Fetch)</div>
    <div class="preview-box" id="integration-js" style="font-size:11px;line-height:1.7;cursor:pointer;" onclick="copyIntegration('js')"></div>
    <div style="font-size:12px;font-weight:700;color:var(--gray);text-transform:uppercase;letter-spacing:0.05em;margin:12px 0 8px;">Verificar key (Luau / Roblox)</div>
    <div class="preview-box" id="integration-luau" style="font-size:11px;line-height:1.7;cursor:pointer;" onclick="copyIntegration('luau')"></div>
    <div style="font-size:11px;color:var(--gray);margin-top:8px;">ðŸ‘† Clique no cÃ³digo para copiar</div>
  </div>
</div>

<!-- ========== BOTTOM NAV ========== -->
<nav class="bottom-nav">
  <div class="nav-item active" onclick="navigate('home')" id="nav-home">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><rect x="3" y="3" width="7" height="7" rx="1.5" opacity="0.85"/><rect x="14" y="3" width="7" height="7" rx="1.5" opacity="0.85"/><rect x="3" y="14" width="7" height="7" rx="1.5" opacity="0.85"/><rect x="14" y="14" width="7" height="7" rx="1.5" opacity="0.85"/></svg>
    <span class="nav-label">Home</span>
  </div>
  <div class="nav-item" onclick="navigate('keys')" id="nav-keys">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6M15.5 7.5l3 3"/></svg>
    <span class="nav-label">Keys</span>
  </div>
  <div class="nav-item" onclick="navigate('devices')" id="nav-devices">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
    <span class="nav-label">Devices</span>
  </div>
  <div class="nav-item" onclick="navigate('packages')" id="nav-packages">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
    <span class="nav-label">Packages</span>
  </div>
  <div class="nav-item" onclick="navigate('profile')" id="nav-profile">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
    <span class="nav-label">Profile</span>
  </div>
</nav>
</div><!-- .phone -->

<script>
/* ============================================================
   STORAGE - Persistent via localStorage
   ============================================================ */
const STORAGE_KEYS = {
  keys: 'ferrao_keys',
  packages: 'ferrao_packages',
  limit: 'ferrao_limit',
  chartData: 'ferrao_chart',
  apiKeys: 'ferrao_api_keys'
};
const KEY_LIMIT = 5000;

function save(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){} }
function load(k, def=null){ try{ const v=localStorage.getItem(k); return v!==null?JSON.parse(v):def; }catch(e){ return def; } }

// ---- State ----
let generatedKeys = load(STORAGE_KEYS.keys, []);   // keys WE generated
let apiKeys = load(STORAGE_KEYS.apiKeys, []);        // keys from remote API
let packages = load(STORAGE_KEYS.packages, [
  { id:'default', name:'API', url:'https://teste-api-mcok.vercel.app/keys', desc:'API principal FERRAO', enabled:true, sent:0 }
]);
let limitCount = load(STORAGE_KEYS.limit, 0);
let chartData = load(STORAGE_KEYS.chartData, {});   // {YYYY-MM-DD: count}
let selectedIds = new Set();

/* ============================================================
   NAVIGATION
   ============================================================ */
function navigate(page){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  document.getElementById('nav-'+page).classList.add('active');
  if(page==='keys') renderKeysList(getMergedKeys());
  if(page==='devices') renderDevicesList(getMergedKeys());
  if(page==='packages') renderPackages();
  if(page==='profile') renderProfile();
}

/* ============================================================
   MERGE: local generated + remote api
   ============================================================ */
function getMergedKeys(){
  const remoteIds = new Set(apiKeys.map(k=>k.id));
  const localOnly = generatedKeys.filter(k=>!remoteIds.has(k.id));
  return [...apiKeys, ...localOnly];
}

/* ============================================================
   FETCH REMOTE API
   ============================================================ */
async function fetchRemoteKeys(){
  try{
    const res = await fetch('https://teste-api-mcok.vercel.app/keys', {
      cache:'no-store',
      headers:{'Accept':'application/json'}
    });
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    if(Array.isArray(data)){
      apiKeys = data;
      save(STORAGE_KEYS.apiKeys, apiKeys);
    }
  }catch(e){ console.warn('API fetch failed:', e.message); }
}

/* ============================================================
   STATS & LIMIT
   ============================================================ */
function updateLimit(added=0){
  limitCount = Math.min(limitCount + added, KEY_LIMIT);
  save(STORAGE_KEYS.limit, limitCount);
  const pct = (limitCount / KEY_LIMIT) * 100;
  document.getElementById('limit-count-text').textContent = `${limitCount.toLocaleString('pt-BR')} / 5.000`;
  document.getElementById('limit-bar').style.width = pct + '%';
  document.getElementById('limit-bar').style.background =
    pct > 90 ? 'linear-gradient(90deg,#f87171,#ef4444)' :
    pct > 70 ? 'linear-gradient(90deg,#fbbf24,#f59e0b)' :
    'linear-gradient(90deg,#4ade80,#22c55e)';
}

function renderStats(){
  const all = getMergedKeys();
  const pending = all.filter(k=>!k.used).length;
  const usedOnes = all.filter(k=>k.used);
  document.getElementById('stat-total').textContent = all.length;
  document.getElementById('stat-pending').textContent = pending;
  document.getElementById('stat-devices').textContent = usedOnes.length;
  document.getElementById('stat-active').textContent = usedOnes.length;
  document.getElementById('keys-count-pill').textContent = all.length;
}

/* ============================================================
   CHART
   ============================================================ */
function buildChartData(){
  const out = {};
  for(let i=6;i>=0;i--){
    const d = new Date(); d.setDate(d.getDate()-i);
    const k = d.toISOString().slice(0,10);
    out[k] = chartData[k] || 0;
  }
  return out;
}

function renderChart(){
  const canvas = document.getElementById('mainChart');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const W = canvas.offsetWidth || 340;
  const H = 170;
  canvas.width = W * dpr;
  canvas.height = H * dpr;
  ctx.scale(dpr, dpr);

  const raw = buildChartData();
  const labels = Object.keys(raw).map(d=>d.slice(5));
  const values = Object.values(raw);
  const maxV = Math.max(...values, 5);

  const pad = {l:36,r:14,t:14,b:30};
  const W2 = W - pad.l - pad.r;
  const H2 = H - pad.t - pad.b;

  ctx.clearRect(0,0,W,H);

  // Grid lines
  ctx.setLineDash([3,4]);
  ctx.strokeStyle='#e9ecf3';
  ctx.lineWidth=1;
  for(let i=0;i<=4;i++){
    const y = pad.t + (H2/4)*i;
    ctx.beginPath(); ctx.moveTo(pad.l,y); ctx.lineTo(W-pad.r,y); ctx.stroke();
    ctx.fillStyle='#9ca3af'; ctx.font=`9px DM Sans`; ctx.textAlign='right';
    ctx.fillText(Math.round(maxV-(maxV/4)*i), pad.l-4, y+4);
  }
  ctx.setLineDash([]);

  // Points
  const pts = values.map((v,i)=>({
    x: pad.l + (W2/(values.length-1||1))*i,
    y: pad.t + H2 - (v/maxV)*H2
  }));

  // Area
  const grad = ctx.createLinearGradient(0,pad.t,0,pad.t+H2);
  grad.addColorStop(0,'rgba(26,86,232,0.18)');
  grad.addColorStop(1,'rgba(26,86,232,0)');
  ctx.beginPath();
  ctx.moveTo(pts[0].x, pts[0].y);
  pts.forEach((p,i)=>{ if(i>0) ctx.lineTo(p.x,p.y); });
  ctx.lineTo(pts[pts.length-1].x, pad.t+H2);
  ctx.lineTo(pts[0].x, pad.t+H2);
  ctx.fillStyle=grad; ctx.fill();

  // Line
  ctx.beginPath(); ctx.strokeStyle='#1a56e8'; ctx.lineWidth=2.5; ctx.lineJoin='round';
  pts.forEach((p,i)=>i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));
  ctx.stroke();

  // Dots
  pts.forEach(p=>{
    ctx.beginPath(); ctx.arc(p.x,p.y,4,0,Math.PI*2);
    ctx.fillStyle='#1a56e8'; ctx.fill();
    ctx.beginPath(); ctx.arc(p.x,p.y,2,0,Math.PI*2);
    ctx.fillStyle='#fff'; ctx.fill();
  });

  // Labels
  ctx.fillStyle='#9ca3af'; ctx.font='9px DM Sans'; ctx.textAlign='center';
  labels.forEach((l,i)=> ctx.fillText(l,pts[i].x,H-6));
}

/* ============================================================
   HOME KEYS PREVIEW
   ============================================================ */
function renderHomeKeys(){
  const el = document.getElementById('home-keys-list');
  const all = getMergedKeys().slice(0,5);
  if(!all.length){ el.innerHTML='<div style="text-align:center;padding:20px;color:#9ca3af;font-size:13px;">Nenhuma key ainda</div>'; return; }
  el.innerHTML = all.map(k=>{
    const b = k.used?'active">Ativa':'pending">Pendente';
    return `<div class="list-item" style="border-radius:12px;margin-bottom:5px;box-shadow:var(--shadow);border:none;">
      <div class="item-body">
        <div class="item-key" style="font-size:12.5px;">${k.key}</div>
        <div class="item-meta">${getTypeLabel(k)}</div>
      </div>
      <span class="badge ${b}</span>
      <button class="copy-btn" onclick="copyText('${k.key}');event.stopPropagation();">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
      </button>
    </div>`;
  }).join('');
}

function getTypeLabel(k){
  if(k.type==='weekly') return '1 semana';
  if(k.type==='monthly') return '1 mÃªs';
  if(k.type==='lifetime') return 'Lifetime';
  if(k.expire) return `${k.expire} ${k.type}`;
  return k.type;
}

/* ============================================================
   KEYS PAGE
   ============================================================ */
function renderKeysList(keys){
  const el = document.getElementById('keys-list');
  if(!keys.length){
    el.innerHTML='<div class="empty"><div class="empty-icon">ðŸ”‘</div><div class="empty-text">Nenhuma key encontrada</div></div>';
    return;
  }
  el.innerHTML = keys.map(k=>{
    const isUsed = k.used;
    const badge = isUsed ? 'active">Ativa' : 'pending">Pendente';
    const isRed = k.key.toUpperCase().includes('-VH');
    const sel = selectedIds.has(k.id);
    return `<div class="list-item${sel?' selected':''}" onclick="toggleSelect('${k.id}',this)">
      <div class="item-check${sel?' checked':''}" id="chk-${k.id}"></div>
      <div class="item-body">
        <div class="item-key${isRed?' red-key':''}">${k.key}</div>
        <div class="item-meta">${getTypeLabel(k)} ${k.device?'Â· ðŸ“± em uso':''}</div>
      </div>
      <span class="badge ${badge}</span>
      <button class="copy-btn" onclick="copyText('${k.key}');event.stopPropagation();" title="Copiar">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
      </button>
    </div>`;
  }).join('');
}

function filterKeys(val){
  const v = val.toLowerCase();
  const filtered = getMergedKeys().filter(k=>
    k.key.toLowerCase().includes(v)||k.type.toLowerCase().includes(v)
  );
  renderKeysList(filtered);
}

function toggleSelect(id, row){
  const chk = document.getElementById('chk-'+id);
  if(selectedIds.has(id)){ selectedIds.delete(id); chk?.classList.remove('checked'); row.classList.remove('selected'); }
  else{ selectedIds.add(id); chk?.classList.add('checked'); row.classList.add('selected'); }
}

function deleteSelected(){
  if(!selectedIds.size){ showToast('âš ï¸ Selecione keys primeiro'); return; }
  const n = selectedIds.size;
  generatedKeys = generatedKeys.filter(k=>!selectedIds.has(k.id));
  apiKeys = apiKeys.filter(k=>!selectedIds.has(k.id));
  save(STORAGE_KEYS.keys, generatedKeys);
  save(STORAGE_KEYS.apiKeys, apiKeys);
  selectedIds.clear();
  renderKeysList(getMergedKeys());
  renderStats();
  renderHomeKeys();
  showToast(`ðŸ—‘ï¸ ${n} key(s) removida(s)`);
}

/* ============================================================
   DEVICES PAGE
   ============================================================ */
function renderDevicesList(keys){
  const el = document.getElementById('devices-list');
  const usedKeys = keys.filter(k=>k.used && k.device);
  if(!usedKeys.length){
    el.innerHTML='<div class="empty"><div class="empty-icon">ðŸ“±</div><div class="empty-text">Nenhum device conectado</div></div>';
    return;
  }
  el.innerHTML = usedKeys.map(k=>{
    const activatedAt = k.activatedAt ? new Date(k.activatedAt*1000).toLocaleString('pt-BR') : 'â€“';
    const expiresAt = k.expiresAt && k.expiresAt > 0 ? new Date(k.expiresAt*1000).toLocaleString('pt-BR') : 'â€“';
    const isExpired = k.expiresAt > 0 && k.expiresAt < Date.now()/1000;
    return `<div class="list-item">
      <div class="item-check"></div>
      <div class="item-body">
        <div class="item-key" style="font-size:12px;">${k.device || '(device desconhecido)'}</div>
        <div class="item-meta" style="font-size:11px;">${k.key}</div>
        <div class="item-meta" style="font-size:10.5px;">Ativado: ${activatedAt}</div>
        ${expiresAt!=='â€“'?`<div class="item-meta" style="font-size:10.5px;">Expira: ${expiresAt}</div>`:''}
      </div>
      <span class="badge ${isExpired?'expired">Expirada':'active">Ativa'}</span>
    </div>`;
  }).join('');
}

function filterDevices(val){
  const v = val.toLowerCase();
  const filtered = getMergedKeys().filter(k=>
    k.device?.toLowerCase().includes(v)||k.key.toLowerCase().includes(v)
  );
  renderDevicesList(filtered);
}

/* ============================================================
   PACKAGES
   ============================================================ */
function renderPackages(){
  const el = document.getElementById('packages-list');
  if(!packages.length){
    el.innerHTML='<div class="empty"><div class="empty-icon">ðŸ“¦</div><div class="empty-text">Nenhum package ainda<br><small style="font-size:12px;color:#9ca3af">Clique em + para adicionar</small></div></div>';
    return;
  }
  el.innerHTML = packages.map((p,i)=>`
    <div class="pkg-item" id="pkg-${p.id}">
      <div class="pkg-icon">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#1a56e8" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
      </div>
      <div class="pkg-body">
        <div class="pkg-name">${p.name}</div>
        <div class="pkg-url">${p.url}</div>
        ${p.desc?`<div class="item-meta" style="margin-top:2px;">${p.desc}</div>`:''}
        <div class="pkg-sent">âœ¦ ${p.sent||0} keys enviadas</div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px;">
        <div class="toggle ${p.enabled?'':'off'}" onclick="togglePkg(${i})"><div class="toggle-knob"></div></div>
        <button onclick="deletePkg(${i})" style="background:none;border:none;cursor:pointer;padding:2px;">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
        </button>
      </div>
    </div>
  `).join('');
}

function togglePkg(i){
  packages[i].enabled = !packages[i].enabled;
  save(STORAGE_KEYS.packages, packages);
  renderPackages();
  updatePkgSelect();
}

function deletePkg(i){
  packages.splice(i,1);
  save(STORAGE_KEYS.packages, packages);
  renderPackages();
  updatePkgSelect();
  showToast('Package removido');
}

function openPkgModal(){
  document.getElementById('pkg-name').value='';
  document.getElementById('pkg-url').value='';
  document.getElementById('pkg-desc').value='';
  openModal('pkg-modal');
}

function addPackage(){
  const name = document.getElementById('pkg-name').value.trim();
  const url = document.getElementById('pkg-url').value.trim();
  const desc = document.getElementById('pkg-desc').value.trim();
  if(!name){ showToast('âš ï¸ Informe o nome'); return; }
  if(!url || !url.startsWith('http')){ showToast('âš ï¸ URL invÃ¡lida'); return; }
  packages.push({ id: Date.now().toString(), name, url, desc, enabled:true, sent:0 });
  save(STORAGE_KEYS.packages, packages);
  renderPackages();
  updatePkgSelect();
  closeModal('pkg-modal');
  showToast(`ðŸ“¦ Package "${name}" adicionado!`);
}

function updatePkgSelect(){
  const sel = document.getElementById('key-package');
  if(!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">â€” Selecionar package â€”</option>' +
    packages.filter(p=>p.enabled).map(p=>`<option value="${p.id}">${p.name} â€” ${p.url.replace('https://','')}</option>`).join('');
  if(cur) sel.value = cur;
  updatePkgHint();
}

function updatePkgHint(){
  const sel = document.getElementById('key-package');
  const hint = document.getElementById('pkg-url-hint');
  if(!sel||!hint) return;
  const p = packages.find(p=>p.id===sel.value);
  hint.textContent = p ? `ðŸ“¡ ${p.url}` : '';
}

/* ============================================================
   CREATE KEY MODAL
   ============================================================ */
function openCreateModal(){
  document.getElementById('generated-results').style.display='none';
  document.getElementById('generated-keys-list').innerHTML='';
  document.getElementById('create-btn-main').disabled=false;
  document.getElementById('create-btn-main').textContent='âœ¦ Gerar Keys';
  updatePkgSelect();
  updatePreview();
  const avail = KEY_LIMIT - limitCount;
  document.getElementById('remaining-hint').textContent = `DisponÃ­vel: ${avail.toLocaleString('pt-BR')} de 5.000`;
  document.getElementById('remaining-hint').className = 'form-hint' + (avail<100?' warn':'');
  openModal('create-modal');
}

function updatePreview(){
  const type = document.getElementById('key-type')?.value || 'weekly';
  document.getElementById('key-preview').textContent = `FERRAO-${type}-${'X'.repeat(10)}${Math.floor(Math.random()*99999)}`;
  updatePkgHint();
}

function generateKeyString(type){
  const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let rand='';
  for(let i=0;i<8;i++) rand+=chars[Math.floor(Math.random()*chars.length)];
  const num = Math.floor(Math.random()*99999).toString().padStart(5,'0');
  return `FERRAO-${type}-${rand}${num}`;
}

async function sendKeyToApi(pkgUrl, keyData){
  try{
    const res = await fetch(pkgUrl, {
      method:'POST',
      headers:{'Content-Type':'application/json','Accept':'application/json'},
      body: JSON.stringify(keyData),
      signal: AbortSignal.timeout(8000)
    });
    return res.ok;
  }catch(e){
    console.warn('API POST failed:', e.message);
    return false; // Still save locally even if API fails
  }
}

async function createKeys(){
  const qty = Math.min(parseInt(document.getElementById('key-qty').value)||1, 100);
  const type = document.getElementById('key-type').value;
  const dur = parseInt(document.getElementById('key-duration').value)||1;
  const pkgId = document.getElementById('key-package').value;

  if(!pkgId){ showToast('âš ï¸ Selecione um Package!'); return; }
  if(limitCount >= KEY_LIMIT){ showToast('âŒ Limite de 5.000 keys atingido!'); return; }

  const realQty = Math.min(qty, KEY_LIMIT - limitCount);
  if(realQty <= 0){ showToast('âŒ Limite de keys atingido!'); return; }

  const pkg = packages.find(p=>p.id===pkgId);
  if(!pkg){ showToast('âš ï¸ Package nÃ£o encontrado'); return; }

  const btn = document.getElementById('create-btn-main');
  btn.disabled = true;
  btn.textContent = 'â³ Gerando e enviando...';

  const today = new Date().toISOString().slice(0,10);
  const newKeys = [];
  const sentOk = [];

  for(let i=0;i<realQty;i++){
    const key = generateKeyString(type);
    const keyObj = {
      id: 'local-'+ Date.now()+'-'+i,
      key, type, expire: dur,
      used: false, device:'', createdAt: Math.floor(Date.now()/1000),
      activatedAt:0, expiresAt:0,
      _pkg: pkg.name, _pkgId: pkgId
    };
    newKeys.push(keyObj);

    // Send to package API
    const ok = await sendKeyToApi(pkg.url, keyObj);
    sentOk.push(ok);
  }

  // Save locally
  generatedKeys.unshift(...newKeys);
  save(STORAGE_KEYS.keys, generatedKeys);

  // Update limit
  updateLimit(realQty);

  // Update chart
  chartData[today] = (chartData[today]||0) + realQty;
  save(STORAGE_KEYS.chartData, chartData);

  // Update package sent count
  const pkgIdx = packages.findIndex(p=>p.id===pkgId);
  if(pkgIdx>=0){ packages[pkgIdx].sent = (packages[pkgIdx].sent||0) + realQty; }
  save(STORAGE_KEYS.packages, packages);

  // Show results
  const resultsEl = document.getElementById('generated-results');
  const listEl = document.getElementById('generated-keys-list');
  const okCount = sentOk.filter(Boolean).length;

  resultsEl.style.display='block';
  listEl.innerHTML = newKeys.map(k=>`
    <div class="result-key-item">
      <div class="result-key-text">${k.key}</div>
      <button class="result-copy-btn" onclick="copyText('${k.key}')">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
      </button>
    </div>
  `).join('');

  btn.disabled = false;
  btn.textContent = `âœ¦ Gerar Mais`;

  renderStats();
  renderHomeKeys();
  renderChart();
  if(document.getElementById('page-keys').classList.contains('active')) renderKeysList(getMergedKeys());

  const apiMsg = okCount === realQty ? `ðŸ“¡ Enviadas para ${pkg.name}!` :
    okCount > 0 ? `âš ï¸ ${okCount}/${realQty} enviadas para ${pkg.name}` :
    `ðŸ’¾ Salvas localmente (API indisponÃ­vel)`;

  showToast(`âœ… ${realQty} key(s) gerada(s)! ${apiMsg}`);
}

let _generatedCopyCache = [];
function copyAllGenerated(){
  const items = document.querySelectorAll('.result-key-text');
  const text = Array.from(items).map(el=>el.textContent).join('\n');
  copyText(text, `${items.length} keys copiadas!`);
}

/* ============================================================
   PROFILE
   ============================================================ */
function renderProfile(){
  const all = getMergedKeys();
  document.getElementById('prof-total').textContent = all.length;
  document.getElementById('prof-used').textContent = all.filter(k=>k.used).length;
  document.getElementById('prof-pkgs').textContent = packages.length;
  document.getElementById('prof-limit').textContent = `${limitCount.toLocaleString('pt-BR')} / 5.000`;
}

function resetAllKeys(){
  if(!confirm('Tem certeza? Isso vai limpar TODAS as keys salvas localmente!')) return;
  generatedKeys = []; apiKeys = []; limitCount = 0; chartData = {};
  save(STORAGE_KEYS.keys, []); save(STORAGE_KEYS.apiKeys, []);
  save(STORAGE_KEYS.limit, 0); save(STORAGE_KEYS.chartData, {});
  updateLimit(0); renderStats(); renderHomeKeys(); renderChart(); renderProfile();
  showToast('ðŸ—‘ï¸ Todas as keys limpas');
}

function copyAllPending(){
  const pending = getMergedKeys().filter(k=>!k.used).map(k=>k.key);
  if(!pending.length){ showToast('Nenhuma key pendente'); return; }
  copyText(pending.join('\n'), `${pending.length} keys pendentes copiadas!`);
}

/* ============================================================
   INTEGRATION MODAL
   ============================================================ */
function showIntegration(){
  const apiUrl = packages[0]?.url || 'https://teste-api-mcok.vercel.app/keys';
  document.getElementById('integration-js').textContent =
`// Verificar key (JavaScript / Fetch)
const API = "${apiUrl}";

async function verificarKey(key) {
  const res = await fetch(API);
  const keys = await res.json();
  const found = keys.find(k => k.key === key);
  if (!found) return { valid: false, reason: "Key nÃ£o encontrada" };
  if (found.used) return { valid: false, reason: "Key jÃ¡ usada" };
  return { valid: true, data: found };
}`;

  document.getElementById('integration-luau').textContent =
`-- Verificar key (Luau / Roblox)
local API = "${apiUrl}"
local HttpService = game:GetService("HttpService")

local function verificarKey(key: string)
  local ok, res = pcall(function()
    return HttpService:GetAsync(API)
  end)
  if not ok then return false end
  local data = HttpService:JSONDecode(res)
  for _, item in ipairs(data) do
    if item.key == key and not item.used then
      return true
    end
  end
  return false
end`;

  openModal('integration-modal');
}

function copyIntegration(type){
  const el = document.getElementById('integration-'+type);
  copyText(el.textContent, 'CÃ³digo copiado!');
}

/* ============================================================
   UTILS
   ============================================================ */
function openModal(id){ document.getElementById(id).classList.add('open'); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }
function closeOnBg(e, id){ if(e.target.id===id) closeModal(id); }

function toggleSearch(page){
  const el = document.getElementById('search-'+page);
  if(el.style.display==='none'||!el.style.display){
    el.style.display='block';
    el.querySelector('input').focus();
  } else {
    el.style.display='none';
    el.querySelector('input').value='';
    if(page==='keys') renderKeysList(getMergedKeys());
    if(page==='devices') renderDevicesList(getMergedKeys());
  }
}

async function copyText(text, msg='Copiado!'){
  try{
    await navigator.clipboard.writeText(text);
    showToast('ðŸ“‹ '+msg);
  }catch(e){
    const ta=document.createElement('textarea');
    ta.value=text; document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); document.body.removeChild(ta);
    showToast('ðŸ“‹ '+msg);
  }
}

function showToast(msg){
  document.querySelectorAll('.toast').forEach(t=>t.remove());
  const t=document.createElement('div');
  t.className='toast'; t.textContent=msg;
  document.querySelector('.phone').appendChild(t);
  setTimeout(()=>t.remove(), 3400);
}

async function refreshAll(){
  showToast('ðŸ”„ Atualizando...');
  await fetchRemoteKeys();
  renderStats();
  renderHomeKeys();
  renderChart();
  const kPage = document.getElementById('page-keys');
  if(kPage.classList.contains('active')) renderKeysList(getMergedKeys());
  const dPage = document.getElementById('page-devices');
  if(dPage.classList.contains('active')) renderDevicesList(getMergedKeys());
  showToast('âœ… Dados atualizados!');
}

/* ============================================================
   INIT
   ============================================================ */
async function init(){
  updateLimit(0); // restore from storage, just re-render
  updatePkgSelect();
  renderStats();
  renderHomeKeys();
  renderChart();
  await fetchRemoteKeys();
  renderStats();
  renderHomeKeys();
}

window.addEventListener('resize', ()=>{ if(document.getElementById('mainChart')) renderChart(); });
init();
</script>
</body>
</html>
